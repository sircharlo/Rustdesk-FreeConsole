# =============================================================================
# BetterDesk Server - Automated Build Pipeline
# =============================================================================
# This workflow builds BetterDesk enhanced binaries for multiple platforms.
#
# Triggers:
#   - Push to 'main' with changes to hbbs-patch-v2/src/**
#   - Manual dispatch with version selection
#   - Pull requests for testing (no artifact upload)
#
# Platforms:
#   - Linux x86_64
#   - Linux aarch64 (ARM64)
#   - Windows x86_64
# =============================================================================

name: Build BetterDesk Binaries

on:
  # Manual trigger with version selection
  workflow_dispatch:
    inputs:
      rustdesk_version:
        description: 'RustDesk Server version to build from'
        required: true
        default: '1.1.14'
        type: string
      upload_release:
        description: 'Upload as GitHub Release'
        required: false
        default: false
        type: boolean
  
  # Auto-trigger on source changes
  push:
    branches: [main]
    paths:
      - 'hbbs-patch-v2/src/**'
      - '.github/workflows/build.yml'
  
  # PR testing
  pull_request:
    branches: [main]
    paths:
      - 'hbbs-patch-v2/src/**'

env:
  RUSTDESK_VERSION: ${{ github.event.inputs.rustdesk_version || '1.1.14' }}
  BETTERDESK_VERSION: '2.0.0'
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Linux x86_64 Build
  # ==========================================================================
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout BetterDesk
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev pkg-config libssl-dev
          
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          
      - name: Clone RustDesk Server
        run: |
          git clone --depth 1 --branch ${{ env.RUSTDESK_VERSION }} https://github.com/rustdesk/rustdesk-server.git
          cd rustdesk-server
          git submodule update --init --recursive
          
      - name: Apply BetterDesk modifications
        run: |
          # Copy all modification files
          for file in main.rs http_api.rs database.rs database_fixed.rs peer.rs peer_fixed.rs rendezvous_server_core.rs; do
            if [ -f "hbbs-patch-v2/src/$file" ]; then
              cp "hbbs-patch-v2/src/$file" "rustdesk-server/src/$file"
              echo "Applied: $file"
            fi
          done
          
      - name: Build binaries
        working-directory: rustdesk-server
        run: |
          cargo build --release -p hbbs
          cargo build --release -p hbbr
          
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp rustdesk-server/target/release/hbbs artifacts/hbbs-linux-x86_64
          cp rustdesk-server/target/release/hbbr artifacts/hbbr-linux-x86_64
          chmod +x artifacts/*
          
          # Generate checksums
          cd artifacts
          sha256sum * > SHA256SUMS-linux-x86_64.txt
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: betterdesk-linux-x86_64
          path: artifacts/*
          retention-days: 30
          
  # ==========================================================================
  # Linux ARM64 Build
  # ==========================================================================
  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout BetterDesk
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev
          sudo apt-get install -y gcc-aarch64-linux-gnu
          
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: aarch64-unknown-linux-gnu
          
      - name: Clone RustDesk Server
        run: |
          git clone --depth 1 --branch ${{ env.RUSTDESK_VERSION }} https://github.com/rustdesk/rustdesk-server.git
          cd rustdesk-server
          git submodule update --init --recursive
          
      - name: Apply BetterDesk modifications
        run: |
          for file in main.rs http_api.rs database.rs database_fixed.rs peer.rs peer_fixed.rs rendezvous_server_core.rs; do
            if [ -f "hbbs-patch-v2/src/$file" ]; then
              cp "hbbs-patch-v2/src/$file" "rustdesk-server/src/$file"
              echo "Applied: $file"
            fi
          done
          
      - name: Configure cross-compilation
        run: |
          mkdir -p .cargo
          cat >> rustdesk-server/.cargo/config.toml << EOF
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF
          
      - name: Build binaries
        working-directory: rustdesk-server
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu -p hbbs
          cargo build --release --target aarch64-unknown-linux-gnu -p hbbr
          
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp rustdesk-server/target/aarch64-unknown-linux-gnu/release/hbbs artifacts/hbbs-linux-aarch64
          cp rustdesk-server/target/aarch64-unknown-linux-gnu/release/hbbr artifacts/hbbr-linux-aarch64
          chmod +x artifacts/*
          
          cd artifacts
          sha256sum * > SHA256SUMS-linux-aarch64.txt
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: betterdesk-linux-aarch64
          path: artifacts/*
          retention-days: 30
          
  # ==========================================================================
  # Windows x86_64 Build
  # ==========================================================================
  build-windows-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout BetterDesk
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          
      - name: Clone RustDesk Server
        run: |
          git clone --depth 1 --branch ${{ env.RUSTDESK_VERSION }} https://github.com/rustdesk/rustdesk-server.git
          cd rustdesk-server
          git submodule update --init --recursive
          
      - name: Apply BetterDesk modifications
        shell: pwsh
        run: |
          $files = @("main.rs", "http_api.rs", "database.rs", "database_fixed.rs", "peer.rs", "peer_fixed.rs", "rendezvous_server_core.rs")
          foreach ($file in $files) {
            $src = "hbbs-patch-v2/src/$file"
            if (Test-Path $src) {
              Copy-Item $src "rustdesk-server/src/$file" -Force
              Write-Host "Applied: $file"
            }
          }
          
      - name: Build binaries
        working-directory: rustdesk-server
        run: |
          cargo build --release -p hbbs
          cargo build --release -p hbbr
          
      - name: Prepare artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          Copy-Item rustdesk-server/target/release/hbbs.exe artifacts/hbbs-windows-x86_64.exe
          Copy-Item rustdesk-server/target/release/hbbr.exe artifacts/hbbr-windows-x86_64.exe
          
          # Generate checksums
          cd artifacts
          Get-ChildItem -File | ForEach-Object {
            $hash = (Get-FileHash $_.Name -Algorithm SHA256).Hash
            "$hash  $($_.Name)" | Out-File -Append SHA256SUMS-windows-x86_64.txt
          }
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: betterdesk-windows-x86_64
          path: artifacts/*
          retention-days: 30
          
  # ==========================================================================
  # Create Release (optional)
  # ==========================================================================
  create-release:
    needs: [build-linux-x64, build-linux-arm64, build-windows-x64]
    runs-on: ubuntu-latest
    if: github.event.inputs.upload_release == 'true'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          
      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Flatten all artifacts
          find all-artifacts -type f -exec cp {} release/ \;
          
          # Generate combined checksums
          cd release
          cat SHA256SUMS-*.txt > SHA256SUMS.txt
          rm SHA256SUMS-*.txt
          
          ls -la
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.BETTERDESK_VERSION }}-${{ github.run_number }}
          name: BetterDesk v${{ env.BETTERDESK_VERSION }} (Build ${{ github.run_number }})
          body: |
            ## BetterDesk Server Binaries
            
            Based on RustDesk Server v${{ env.RUSTDESK_VERSION }}
            
            ### Downloads
            
            | Platform | Signal Server (hbbs) | Relay Server (hbbr) |
            |----------|---------------------|---------------------|
            | Linux x86_64 | `hbbs-linux-x86_64` | `hbbr-linux-x86_64` |
            | Linux ARM64 | `hbbs-linux-aarch64` | `hbbr-linux-aarch64` |
            | Windows | `hbbs-windows-x86_64.exe` | `hbbr-windows-x86_64.exe` |
            
            ### Installation
            
            **Linux:**
            ```bash
            chmod +x hbbs-linux-x86_64 hbbr-linux-x86_64
            ./hbbs-linux-x86_64 -k _ --api-port 21114
            ./hbbr-linux-x86_64
            ```
            
            **Windows:**
            ```powershell
            .\hbbs-windows-x86_64.exe -k _ --api-port 21114
            .\hbbr-windows-x86_64.exe
            ```
            
            See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for full installation instructions.
            
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  # ==========================================================================
  # Update Repository Binaries
  # ==========================================================================
  update-repo-binaries:
    needs: [build-linux-x64, build-windows-x64]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download Linux x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: betterdesk-linux-x86_64
          path: new-binaries/linux-x64
          
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: betterdesk-windows-x86_64
          path: new-binaries/windows
          
      - name: Update repository binaries
        run: |
          # Update Linux binaries
          cp new-binaries/linux-x64/hbbs-linux-x86_64 hbbs-patch-v2/
          cp new-binaries/linux-x64/hbbr-linux-x86_64 hbbs-patch-v2/
          chmod +x hbbs-patch-v2/hbbs-linux-x86_64 hbbs-patch-v2/hbbr-linux-x86_64
          
          # Update Windows binaries
          cp new-binaries/windows/hbbs-windows-x86_64.exe hbbs-patch-v2/
          cp new-binaries/windows/hbbr-windows-x86_64.exe hbbs-patch-v2/
          
          # Update checksums
          cd hbbs-patch-v2
          echo "# BetterDesk Binary Checksums" > CHECKSUMS.md
          echo "" >> CHECKSUMS.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> CHECKSUMS.md
          echo "RustDesk Base: ${{ env.RUSTDESK_VERSION }}" >> CHECKSUMS.md
          echo "Build: #${{ github.run_number }}" >> CHECKSUMS.md
          echo "" >> CHECKSUMS.md
          echo "\`\`\`" >> CHECKSUMS.md
          sha256sum hbbs-* hbbr-* 2>/dev/null | grep -v ".md" >> CHECKSUMS.md
          echo "\`\`\`" >> CHECKSUMS.md
          
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hbbs-patch-v2/
          git diff --staged --quiet || git commit -m "chore: Update BetterDesk binaries (Build #${{ github.run_number }})"
          git push
