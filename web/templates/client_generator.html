<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>BetterDesk Console - Client Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=app_version) }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #00d68f;
            --warning-color: #ffaa00;
            --danger-color: #ff3d71;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Sidebar - consistent with main panel */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 260px;
            background: rgba(15, 23, 42, 0.98);
            border-right: 1px solid var(--glass-border);
            padding: 20px 0;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sidebar-logo i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .sidebar-user {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .sidebar-user-name {
            color: #fff;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .sidebar-user-role {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .sidebar-menu {
            padding: 0 10px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .sidebar-item.active {
            background: var(--primary-gradient);
            color: #fff;
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            border-top: 1px solid var(--glass-border);
            background: rgba(15, 23, 42, 0.95);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
        }

        .page-header h1 i {
            color: var(--primary-color);
        }

        .page-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        /* Glass Card */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-header i {
            font-size: 1.4rem;
            color: var(--primary-color);
        }

        .card-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Platform Selection */
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .platform-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .platform-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .platform-card.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: var(--primary-color);
        }

        .platform-card i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .platform-card.selected i {
            color: var(--primary-color);
        }

        .platform-card .platform-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .platform-card .platform-arch {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .form-group small {
            display: block;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 6px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        select.form-control {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        select.form-control option {
            background: #1a1a2e;
            color: #fff;
            padding: 10px;
        }

        select.form-control option:hover,
        select.form-control option:checked {
            background: #667eea;
            color: #fff;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Row Layout */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Checkbox/Toggle */
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-group:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-group input {
            display: none;
        }

        .toggle-group input:checked + .toggle-switch {
            background: var(--primary-color);
        }

        .toggle-group input:checked + .toggle-switch::after {
            left: 22px;
        }

        .toggle-label {
            flex: 1;
            font-size: 0.9rem;
        }

        .toggle-label small {
            display: block;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-top: 2px;
        }

        /* Collapsible Sections */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .collapsible-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 500;
        }

        .collapsible-header i.toggle-icon {
            transition: transform 0.3s ease;
        }

        .collapsible-header.collapsed i.toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            padding: 0 10px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        /* Progress Section */
        .build-progress {
            display: none;
        }

        .build-progress.active {
            display: block;
        }

        .progress-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .progress-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 12px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 8px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .progress-status {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            opacity: 0.4;
        }

        .progress-step.active {
            opacity: 1;
        }

        .progress-step.completed {
            opacity: 1;
        }

        .progress-step.completed .step-icon {
            background: var(--success-color);
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-step.active .step-icon {
            background: var(--primary-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .step-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #00d68f 0%, #00b887 100%);
            color: #fff;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        /* Download Result */
        .download-result {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .download-result.active {
            display: block;
        }

        .download-result .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
        }

        .download-result h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .download-result p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 25px;
        }

        .download-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .download-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .download-info-row:last-child {
            border-bottom: none;
        }

        .download-info-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .download-info-value {
            font-weight: 500;
        }

        /* Alert */
        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert-info {
            background: rgba(79, 172, 254, 0.15);
            border: 1px solid rgba(79, 172, 254, 0.3);
            color: #4facfe;
        }

        .alert-warning {
            background: rgba(255, 170, 0, 0.15);
            border: 1px solid rgba(255, 170, 0, 0.3);
            color: #ffaa00;
        }

        .alert i {
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-content strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Version Select */
        .version-select-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .version-select-container .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .version-refresh {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .version-refresh:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .version-refresh.loading i {
            animation: spin 1s linear infinite;
        }

        /* File Upload */
        .file-upload {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--glass-border);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .file-upload:hover .file-upload-btn {
            border-color: var(--primary-color);
            color: #fff;
        }

        .file-name {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Permissions Grid */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .platform-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .progress-steps {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-shield-halved"></i>
                <span>BetterDesk v2.0</span>
            </div>
            <div class="sidebar-user">
                <div class="sidebar-user-name" id="sidebarUsername">Loading...</div>
                <div class="sidebar-user-role" id="sidebarRole">...</div>
            </div>
        </div>

        <div class="sidebar-menu">
            <a class="sidebar-item" href="/">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </a>
            <a class="sidebar-item active" href="/client-generator">
                <i class="fas fa-box-open"></i>
                <span>Client Generator</span>
            </a>
            <a class="sidebar-item" href="/?section=publickey">
                <i class="fas fa-key"></i>
                <span>Public Key</span>
            </a>
            <a class="sidebar-item" href="/?section=settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
            <a class="sidebar-item admin-only" href="/?section=users" style="display: none;">
                <i class="fas fa-users-cog"></i>
                <span>User Management</span>
            </a>
            <a class="sidebar-item" href="/?section=about">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
            </a>
        </div>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i class="fas fa-box-open"></i>
                Client Generator
            </h1>
            <p>Create custom RustDesk clients with your server configuration pre-configured</p>
        </div>

        <!-- Configuration Form -->
        <div id="configForm">
            <!-- Build Mode Selection -->
            <div class="glass-card" id="buildModeCard">
                <div class="card-header">
                    <i class="fas fa-tools"></i>
                    <h2>Build Method</h2>
                </div>
                <div class="build-mode-selection" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="build-mode-option" style="flex: 1; min-width: 280px;" id="sourceModeOption">
                        <input type="hidden" name="buildMode" value="source">
                        <div class="mode-card selected" style="padding: 20px; background: rgba(0,214,143,0.1); border-radius: 12px; border: 2px solid #00d68f; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                <i class="fas fa-code" style="font-size: 2rem; color: #00d68f;"></i>
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">Source Compilation</h4>
                                    <span style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Build time: ~10-15 min</span>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin: 0;">
                                Compiles RustDesk from source with your custom server configuration, branding, logo, and app name.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Supported platforms info for Source mode -->
                <div id="sourcePlatformsInfo" style="margin-top: 15px; padding: 12px; background: rgba(0,214,143,0.1); border: 1px solid rgba(0,214,143,0.3); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <i class="fas fa-info-circle" style="color: #00d68f;"></i>
                        <strong style="color: #00d68f;">Supported platforms (source compilation):</strong>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <span class="platform-badge supported" style="padding: 4px 12px; background: rgba(0,214,143,0.2); border-radius: 4px; font-size: 0.85rem;">
                            <i class="fab fa-linux"></i> Linux x64
                        </span>
                        <span class="platform-badge supported" style="padding: 4px 12px; background: rgba(0,214,143,0.2); border-radius: 4px; font-size: 0.85rem;">
                            <i class="fab fa-linux"></i> Linux ARM64
                        </span>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                        <i class="fas fa-check-circle" style="color: #00d68f;"></i> Source compilation creates a custom client with embedded server configuration, custom name and logo.
                        <br><i class="fas fa-clock" style="color: #ffc107;"></i> Build time: 5-15 minutes (first build takes longer due to dependency download).
                    </p>
                </div>
            </div>

            <!-- Platform Selection -->
            <div class="glass-card">
                <div class="card-header">
                    <i class="fas fa-desktop"></i>
                    <h2>Target Platform</h2>
                </div>
                <div class="platform-grid">
                    <div class="platform-card selected" data-platform="linux-x64">
                        <i class="fab fa-linux"></i>
                        <div class="platform-name">Linux</div>
                        <div class="platform-arch">x86_64</div>
                        <div class="platform-supported" style="font-size: 0.75rem; color: #00d68f; margin-top: 5px;">
                            <i class="fas fa-check-circle"></i> Supported
                        </div>
                    </div>
                    <div class="platform-card" data-platform="linux-arm64">
                        <i class="fab fa-linux"></i>
                        <div class="platform-name">Linux</div>
                        <div class="platform-arch">ARM64</div>
                        <div class="platform-supported" style="font-size: 0.75rem; color: #00d68f; margin-top: 5px;">
                            <i class="fas fa-check-circle"></i> Supported
                        </div>
                    </div>
                    <div class="platform-card" data-platform="windows-x64">
                        <i class="fab fa-windows"></i>
                        <div class="platform-name">Windows</div>
                        <div class="platform-arch">64-bit (x64)</div>
                        <div class="platform-unavailable" style="font-size: 0.75rem; color: #ffc107; margin-top: 5px;">
                            <i class="fas fa-exclamation-triangle"></i> Experimental
                        </div>
                    </div>
                    <div class="platform-card" data-platform="windows-x86">
                        <i class="fab fa-windows"></i>
                        <div class="platform-name">Windows</div>
                        <div class="platform-arch">32-bit (x86)</div>
                        <div class="platform-unavailable" style="font-size: 0.75rem; color: #ffc107; margin-top: 5px;">
                            <i class="fas fa-exclamation-triangle"></i> Experimental
                        </div>
                    </div>
                    <div class="platform-card" data-platform="macos-x64">
                        <i class="fab fa-apple"></i>
                        <div class="platform-name">macOS</div>
                        <div class="platform-arch">Intel (x64)</div>
                        <div class="platform-unavailable" style="font-size: 0.75rem; color: #ff6b6b; margin-top: 5px;">
                            <i class="fas fa-times-circle"></i> Not supported
                        </div>
                    </div>
                    <div class="platform-card" data-platform="macos-arm64">
                        <i class="fab fa-apple"></i>
                        <div class="platform-name">macOS</div>
                        <div class="platform-arch">Apple Silicon</div>
                        <div class="platform-unavailable" style="font-size: 0.75rem; color: #ff6b6b; margin-top: 5px;">
                            <i class="fas fa-times-circle"></i> Not supported
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 8px; font-size: 0.85rem;">
                    <i class="fas fa-info-circle" style="color: #ffc107;"></i>
                    <strong>Note:</strong> Linux platforms are fully supported for source compilation.
                    Windows requires vcpkg cross-compilation setup (experimental).
                    macOS requires native Apple hardware.
                </div>
            </div>

            <!-- Version & Basic Config -->
            <div class="glass-card">
                <div class="card-header">
                    <i class="fas fa-sliders-h"></i>
                    <h2>Basic Configuration</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>RustDesk Version</label>
                        <div class="version-select-container">
                            <div class="form-group">
                                <select class="form-control" id="rustdeskVersion">
                                    <option value="loading">Loading versions...</option>
                                </select>
                            </div>
                            <button type="button" class="version-refresh" id="refreshVersions" title="Refresh versions">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <small>Select the RustDesk version to use</small>
                    </div>
                    <div class="form-group">
                        <label>Output Filename</label>
                        <input type="text" class="form-control" id="clientName" placeholder="e.g., MyCompany-Remote" value="Custom-RustDesk">
                        <small>Filename for the generated client (without extension)</small>
                    </div>
                </div>
            </div>

            <!-- Branding / Customization -->
            <div class="glass-card">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <h3><i class="fas fa-palette"></i> Branding & Customization</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="collapsible-content" style="display: block;">
                    <div class="branding-info" style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                        <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                        <span style="margin-left: 8px; font-size: 0.9rem;">Customize how the RustDesk client appears to users. Logo and text will be displayed in the client's main window.</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Application Name</label>
                        <input type="text" class="form-control" id="appName" placeholder="e.g., MyCompany Remote Support" value="">
                        <small>Name displayed in the client window title (leave empty for default "RustDesk")</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Logo Image</label>
                            <div class="logo-upload-container" style="display: flex; gap: 10px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <input type="file" class="form-control" id="logoFile" accept="image/png,image/jpeg,image/svg+xml" style="display: none;">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('logoFile').click()" style="width: 100%;">
                                        <i class="fas fa-upload"></i> Upload Logo
                                    </button>
                                    <small>PNG, JPG or SVG (max 256x256px recommended)</small>
                                </div>
                                <div id="logoPreview" style="width: 64px; height: 64px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <i class="fas fa-image" style="color: rgba(255,255,255,0.3); font-size: 24px;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Or Logo URL</label>
                            <input type="text" class="form-control" id="logoUrl" placeholder="https://example.com/logo.png">
                            <small>Direct URL to logo image (alternative to upload)</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Text</label>
                        <input type="text" class="form-control" id="customText" placeholder="e.g., IT Support - Call 123-456-789" value="">
                        <small>Text displayed below the logo in client window (support contact, company name, etc.)</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Icon (Windows)</label>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="file" class="form-control" id="iconFile" accept=".ico,image/x-icon" style="display: none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('iconFile').click()" style="width: 100%;">
                                    <i class="fas fa-icons"></i> Upload Icon (.ico)
                                </button>
                                <small>Windows icon file for taskbar/shortcuts</small>
                            </div>
                            <div id="iconPreview" style="width: 48px; height: 48px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                <i class="fas fa-window-maximize" style="color: rgba(255,255,255,0.3); font-size: 20px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Server Configuration -->
            <div class="glass-card">
                <div class="card-header">
                    <i class="fas fa-server"></i>
                    <h2>Server Configuration</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Server Address <span class="required">*</span></label>
                        <input type="text" class="form-control" id="serverHost" placeholder="your-server.com or IP address">
                        <small>Your RustDesk server hostname or IP</small>
                    </div>
                    <div class="form-group">
                        <label>Server Public Key <span class="required">*</span></label>
                        <input type="text" class="form-control" id="serverKey" placeholder="Will be auto-filled from server">
                        <small>Your server's public key for secure connection</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>API Server URL (Optional)</label>
                    <input type="text" class="form-control" id="apiServer" placeholder="https://your-server.com:21114">
                    <small>Only needed if using custom API port</small>
                </div>

                <button type="button" class="btn btn-secondary" onclick="autoFillServerConfig()">
                    <i class="fas fa-magic"></i>
                    Auto-fill from current server
                </button>
            </div>

            <!-- Security Options -->
            <div class="glass-card">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <h3><i class="fas fa-shield-alt"></i> Security Options</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Password Approval Mode</label>
                            <select class="form-control" id="approvalMode">
                                <option value="click">Click to approve</option>
                                <option value="password">Password required</option>
                                <option value="both" selected>Both (click or password)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Permanent Password (Optional)</label>
                            <input type="password" class="form-control" id="permanentPassword" placeholder="Leave empty for none">
                            <small>Pre-configured permanent password</small>
                        </div>
                    </div>

                    <div class="form-row" style="margin-top: 15px;">
                        <label class="toggle-group">
                            <input type="checkbox" id="denyLanDiscovery">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                Deny LAN Discovery
                                <small>Prevent discovery on local network</small>
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="enableDirectIP">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                Enable Direct IP Access
                                <small>Allow connections via direct IP</small>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Permissions -->
            <div class="glass-card">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <h3><i class="fas fa-user-shield"></i> Default Permissions</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="collapsible-content">
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        Configure which permissions are enabled by default for remote sessions.
                    </p>
                    <div class="permissions-grid">
                        <label class="toggle-group">
                            <input type="checkbox" id="permKeyboard" checked>
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-keyboard"></i> Keyboard Input
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permClipboard" checked>
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-clipboard"></i> Clipboard Sync
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permFileTransfer" checked>
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-file-export"></i> File Transfer
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permAudio" checked>
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-volume-up"></i> Audio Streaming
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permTcpTunnel">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-network-wired"></i> TCP Tunneling
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permRestart">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-redo"></i> Remote Restart
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permRecording">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-video"></i> Session Recording
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="permBlockInput">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                <i class="fas fa-ban"></i> Block User Input
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Display Options -->
            <div class="glass-card">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <h3><i class="fas fa-palette"></i> Display Options</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Default Theme</label>
                            <select class="form-control" id="theme">
                                <option value="system">Follow System</option>
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Default View Mode</label>
                            <select class="form-control" id="viewMode">
                                <option value="adaptive">Adaptive</option>
                                <option value="original">Original Resolution</option>
                                <option value="shrink">Shrink Only</option>
                                <option value="stretch">Stretch</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 15px;">
                        <label class="toggle-group">
                            <input type="checkbox" id="removeWallpaper">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                Remove Wallpaper During Session
                                <small>Improves performance</small>
                            </span>
                        </label>
                        <label class="toggle-group">
                            <input type="checkbox" id="showQualityMonitor">
                            <span class="toggle-switch"></span>
                            <span class="toggle-label">
                                Show Quality Monitor
                                <small>Display FPS/latency overlay</small>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="glass-card">
                <div class="collapsible-header collapsed" onclick="toggleSection(this)">
                    <h3><i class="fas fa-cogs"></i> Advanced Options</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="collapsible-content collapsed">
                    <div class="alert alert-warning" style="margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="alert-content">
                            <strong>Advanced Settings</strong>
                            Only modify these if you know what you're doing.
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Custom Rendezvous Server</label>
                        <input type="text" class="form-control" id="rendezvousServer" placeholder="Leave empty to use main server">
                        <small>Separate rendezvous server if different from relay</small>
                    </div>

                    <div class="form-group">
                        <label>Default Settings JSON</label>
                        <textarea class="form-control" id="defaultSettings" placeholder='{"option_name": "value"}'></textarea>
                        <small>Additional RustDesk settings in JSON format</small>
                    </div>

                    <div class="form-group">
                        <label>Override Settings JSON</label>
                        <textarea class="form-control" id="overrideSettings" placeholder='{"option_name": "value"}'></textarea>
                        <small>Settings that cannot be changed by user</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" id="generateBtn" onclick="startGeneration()">
                    <i class="fas fa-cog"></i>
                    Generate Client
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Reset to Defaults
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="build-progress" id="buildProgress">
            <div class="glass-card">
                <div class="progress-container">
                    <div class="progress-spinner"></div>
                    <div class="progress-text" id="progressText">Preparing...</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-status" id="progressStatus">Initializing build process</div>

                    <div class="progress-steps">
                        <div class="progress-step" id="step1">
                            <div class="step-icon"><i class="fas fa-download"></i></div>
                            <span class="step-label">Download</span>
                        </div>
                        <div class="progress-step" id="step2">
                            <div class="step-icon"><i class="fas fa-file-code"></i></div>
                            <span class="step-label">Configure</span>
                        </div>
                        <div class="progress-step" id="step3">
                            <div class="step-icon"><i class="fas fa-box"></i></div>
                            <span class="step-label">Package</span>
                        </div>
                        <div class="progress-step" id="step4">
                            <div class="step-icon"><i class="fas fa-check"></i></div>
                            <span class="step-label">Complete</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="justify-content: center;">
                <button type="button" class="btn btn-secondary" onclick="cancelGeneration()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>

        <!-- Download Result -->
        <div class="download-result" id="downloadResult">
            <div class="glass-card">
                <div class="success-icon">
                    <i class="fas fa-check"></i>
                </div>
                <h3>Client Generated Successfully!</h3>
                <p>Your custom RustDesk client is ready for download.</p>

                <div class="download-info">
                    <div class="download-info-row">
                        <span class="download-info-label">Filename</span>
                        <span class="download-info-value" id="resultFilename">-</span>
                    </div>
                    <div class="download-info-row">
                        <span class="download-info-label">Platform</span>
                        <span class="download-info-value" id="resultPlatform">-</span>
                    </div>
                    <div class="download-info-row">
                        <span class="download-info-label">Version</span>
                        <span class="download-info-value" id="resultVersion">-</span>
                    </div>
                    <div class="download-info-row">
                        <span class="download-info-label">Size</span>
                        <span class="download-info-value" id="resultSize">-</span>
                    </div>
                </div>

                <div class="action-buttons" style="justify-content: center;">
                    <button type="button" class="btn btn-success" id="downloadBtn">
                        <i class="fas fa-download"></i>
                        Download Client
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="generateAnother()">
                        <i class="fas fa-plus"></i>
                        Generate Another
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // State
    let selectedPlatform = 'linux-x64';
    let buildInProgress = false;
    let buildCancelled = false;
    let logoBase64 = '';
    let iconBase64 = '';
    let sourceCompilationAvailable = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        initPlatformSelection();
        loadVersions();
        autoFillServerConfig();
        initBrandingUploads();
        initBuildModeSelection();
        checkGeneratorCapabilities();
    });

    // Check generator capabilities
    async function checkGeneratorCapabilities() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/generator/info', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                sourceCompilationAvailable = data.sourceCompilationAvailable;
                
                if (!sourceCompilationAvailable) {
                    // Show unavailable note
                    const note = document.getElementById('sourceUnavailableNote');
                    if (note) note.style.display = 'block';
                    
                    // Disable source mode option
                    const sourceOption = document.getElementById('sourceModeOption');
                    if (sourceOption) {
                        sourceOption.style.opacity = '0.5';
                        sourceOption.querySelector('input').disabled = true;
                    }
                }
            }
        } catch (e) {
            console.log('Could not check generator capabilities:', e);
        }
    }

    // Initialize build mode selection
    function initBuildModeSelection() {
        const modeOptions = document.querySelectorAll('input[name="buildMode"]');
        modeOptions.forEach(radio => {
            radio.addEventListener('change', function() {
                updateBuildModeUI(this.value);
            });
        });
        
        // Style selected radio cards
        document.querySelectorAll('.build-mode-option').forEach(option => {
            option.addEventListener('click', function() {
                const input = this.querySelector('input');
                if (!input.disabled) {
                    input.checked = true;
                    input.dispatchEvent(new Event('change'));
                }
            });
        });
        
        // Initial UI update - default to source compilation
        updateBuildModeUI('source');
    }

    // Platforms supported by source compilation (Linux only)
    const SOURCE_SUPPORTED_PLATFORMS = ['linux-x64', 'linux-arm64'];
    
    function updateBuildModeUI(mode) {
        // Update card styling
        document.querySelectorAll('.build-mode-option .mode-card').forEach(card => {
            card.style.border = '2px solid transparent';
        });
        
        const selectedInput = document.querySelector(`input[name="buildMode"][value="${mode}"]`);
        if (selectedInput) {
            const selectedCard = selectedInput.closest('.build-mode-option').querySelector('.mode-card');
            selectedCard.style.border = mode === 'source' ? '2px solid #00d68f' : '2px solid #667eea';
        }
        
        // Update info alerts
        const configInfo = document.getElementById('configModeInfo');
        const sourceInfo = document.getElementById('sourceModeInfo');
        const sourcePlatformsInfo = document.getElementById('sourcePlatformsInfo');
        
        if (mode === 'source') {
            if (configInfo) configInfo.style.display = 'none';
            if (sourceInfo) sourceInfo.style.display = 'flex';
            if (sourcePlatformsInfo) sourcePlatformsInfo.style.display = 'block';
        } else {
            if (configInfo) configInfo.style.display = 'flex';
            if (sourceInfo) sourceInfo.style.display = 'none';
            if (sourcePlatformsInfo) sourcePlatformsInfo.style.display = 'none';
        }
        
        // Update platform availability based on mode
        updatePlatformCards(mode);
    }
    
    function updatePlatformAvailability(mode) {
        // Legacy function - now handled by updatePlatformCards
        updatePlatformCards(mode);
    }

    function getSelectedBuildMode() {
        const selected = document.querySelector('input[name="buildMode"]:checked');
        return selected ? selected.value : 'source';
    }

    // Initialize branding file uploads
    function initBrandingUploads() {
        // Logo file upload
        document.getElementById('logoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 500000) { // 500KB max
                    alert('Logo file too large. Maximum size is 500KB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    logoBase64 = event.target.result;
                    document.getElementById('logoPreview').innerHTML = 
                        `<img src="${logoBase64}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                    document.getElementById('logoUrl').value = ''; // Clear URL if file uploaded
                };
                reader.readAsDataURL(file);
            }
        });

        // Icon file upload
        document.getElementById('iconFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 200000) { // 200KB max for icons
                    alert('Icon file too large. Maximum size is 200KB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    iconBase64 = event.target.result;
                    document.getElementById('iconPreview').innerHTML = 
                        `<img src="${iconBase64}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Logo URL change - show preview and clear file
        document.getElementById('logoUrl').addEventListener('change', function(e) {
            if (e.target.value) {
                logoBase64 = '';
                document.getElementById('logoFile').value = '';
                document.getElementById('logoPreview').innerHTML = 
                    `<img src="${e.target.value}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-exclamation-triangle\\' style=\\'color: #ff3d71;\\'></i>'">`;
            }
        });
    }

    // Auth check
    function checkAuth() {
        const token = localStorage.getItem('authToken');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        document.getElementById('sidebarUsername').textContent = username || 'User';
        document.getElementById('sidebarRole').textContent = role || 'viewer';

        if (role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
        }

        // Verify token
        fetch('/api/auth/verify', {
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(r => {
            if (!r.ok) {
                localStorage.clear();
                window.location.href = '/login';
            }
        }).catch(() => window.location.href = '/login');
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/login';
    }

    // Platform Selection
    function initPlatformSelection() {
        document.querySelectorAll('.platform-card').forEach(card => {
            card.addEventListener('click', function() {
                const platform = this.dataset.platform;
                
                // Show warning for unsupported platforms but allow selection
                if (platform.includes('macos')) {
                    if (!confirm('macOS compilation requires Apple hardware and macOS SDK.\n\nThis platform is NOT supported for cross-compilation from Linux.\nAre you sure you want to select it anyway?')) {
                        return;
                    }
                } else if (platform.includes('windows')) {
                    if (!confirm('Windows cross-compilation from Linux requires complex vcpkg setup with Windows-targeted dependencies.\n\nThis may fail without proper configuration.\nAre you sure you want to continue?')) {
                        return;
                    }
                }
                
                document.querySelectorAll('.platform-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedPlatform = platform;
            });
        });
        
        // No need for updatePlatformCards - all platforms are selectable
    }
    
    function updatePlatformCards(mode) {
        document.querySelectorAll('.platform-card').forEach(card => {
            const platform = card.dataset.platform;
            const unavailableMsg = card.querySelector('.platform-unavailable');
            const supportedMsg = card.querySelector('.platform-supported');
            
            if (mode === 'source') {
                if (!SOURCE_SUPPORTED_PLATFORMS.includes(platform)) {
                    card.classList.add('disabled');
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                    if (unavailableMsg) unavailableMsg.style.display = 'block';
                } else {
                    card.classList.remove('disabled');
                    card.style.opacity = '1';
                    card.style.cursor = 'pointer';
                    if (unavailableMsg) unavailableMsg.style.display = 'none';
                    if (supportedMsg) supportedMsg.style.display = 'block';
                }
            } else {
                // Config injection - all platforms available
                card.classList.remove('disabled');
                card.style.opacity = '1';
                card.style.cursor = 'pointer';
                if (unavailableMsg) unavailableMsg.style.display = 'none';
                if (supportedMsg) supportedMsg.style.display = 'none';
            }
        });
        
        // If current selection is disabled, switch to linux-x64
        const currentCard = document.querySelector('.platform-card.selected');
        if (currentCard && currentCard.classList.contains('disabled')) {
            document.querySelectorAll('.platform-card').forEach(c => c.classList.remove('selected'));
            const linuxCard = document.querySelector('.platform-card[data-platform="linux-x64"]');
            if (linuxCard) {
                linuxCard.classList.add('selected');
                selectedPlatform = 'linux-x64';
            }
        }
    }

    // Load versions from GitHub
    async function loadVersions() {
        const select = document.getElementById('rustdeskVersion');
        const refreshBtn = document.getElementById('refreshVersions');
        const token = localStorage.getItem('authToken');

        refreshBtn.classList.add('loading');
        select.innerHTML = '<option value="loading">Loading...</option>';

        try {
            const response = await fetch('/api/generator/versions', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            if (data.success && data.versions && data.versions.length > 0) {
                select.innerHTML = data.versions.map((v, i) => 
                    `<option value="${v.tag}" ${i === 0 ? 'selected' : ''}>${v.tag} ${i === 0 ? '(Latest)' : ''}</option>`
                ).join('');
            } else {
                throw new Error('No versions returned');
            }
        } catch (e) {
            console.error('Failed to load versions:', e);
            // Updated fallback versions
            select.innerHTML = `
                <option value="1.4.5" selected>1.4.5 (Latest)</option>
                <option value="1.4.4">1.4.4</option>
                <option value="1.4.3">1.4.3</option>
                <option value="1.3.9">1.3.9</option>
                <option value="1.3.7">1.3.7</option>
            `;
        }

        refreshBtn.classList.remove('loading');
    }

    document.getElementById('refreshVersions').addEventListener('click', loadVersions);

    // Auto-fill server config
    async function autoFillServerConfig() {
        try {
            // Get server host from current URL
            const serverHost = window.location.hostname;
            document.getElementById('serverHost').value = serverHost;

            // Try to get public key
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/public-key', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.key) {
                document.getElementById('serverKey').value = data.key;
            }
        } catch (e) {
            console.error('Auto-fill failed:', e);
        }
    }

    // Toggle collapsible sections
    function toggleSection(header) {
        header.classList.toggle('collapsed');
        const content = header.nextElementSibling;
        content.classList.toggle('collapsed');
    }

    // Reset form
    function resetForm() {
        document.getElementById('clientName').value = 'Custom-RustDesk';
        document.getElementById('permanentPassword').value = '';
        document.getElementById('denyLanDiscovery').checked = false;
        document.getElementById('enableDirectIP').checked = false;
        document.getElementById('approvalMode').value = 'both';
        document.getElementById('theme').value = 'system';
        document.getElementById('viewMode').value = 'adaptive';

        // Reset permissions
        document.getElementById('permKeyboard').checked = true;
        document.getElementById('permClipboard').checked = true;
        document.getElementById('permFileTransfer').checked = true;
        document.getElementById('permAudio').checked = true;
        document.getElementById('permTcpTunnel').checked = false;
        document.getElementById('permRestart').checked = false;
        document.getElementById('permRecording').checked = false;
        document.getElementById('permBlockInput').checked = false;

        document.getElementById('removeWallpaper').checked = false;
        document.getElementById('showQualityMonitor').checked = false;
        document.getElementById('defaultSettings').value = '';
        document.getElementById('overrideSettings').value = '';
        document.getElementById('rendezvousServer').value = '';
    }

    // Collect form data
    function collectFormData() {
        const buildMode = getSelectedBuildMode();
        return {
            platform: selectedPlatform,
            version: document.getElementById('rustdeskVersion').value,
            clientName: document.getElementById('clientName').value || 'Custom-RustDesk',
            serverHost: document.getElementById('serverHost').value,
            serverKey: document.getElementById('serverKey').value,
            apiServer: document.getElementById('apiServer').value,
            // Build mode
            compileFromSource: buildMode === 'source',
            // Branding
            appName: document.getElementById('appName').value,
            logoBase64: logoBase64,
            logoUrl: document.getElementById('logoUrl').value,
            customText: document.getElementById('customText').value,
            iconBase64: iconBase64,
            // Security
            approvalMode: document.getElementById('approvalMode').value,
            permanentPassword: document.getElementById('permanentPassword').value,
            denyLanDiscovery: document.getElementById('denyLanDiscovery').checked,
            enableDirectIP: document.getElementById('enableDirectIP').checked,
            theme: document.getElementById('theme').value,
            viewMode: document.getElementById('viewMode').value,
            removeWallpaper: document.getElementById('removeWallpaper').checked,
            showQualityMonitor: document.getElementById('showQualityMonitor').checked,
            permissions: {
                keyboard: document.getElementById('permKeyboard').checked,
                clipboard: document.getElementById('permClipboard').checked,
                fileTransfer: document.getElementById('permFileTransfer').checked,
                audio: document.getElementById('permAudio').checked,
                tcpTunnel: document.getElementById('permTcpTunnel').checked,
                restart: document.getElementById('permRestart').checked,
                recording: document.getElementById('permRecording').checked,
                blockInput: document.getElementById('permBlockInput').checked
            },
            rendezvousServer: document.getElementById('rendezvousServer').value,
            defaultSettings: document.getElementById('defaultSettings').value,
            overrideSettings: document.getElementById('overrideSettings').value
        };
    }

    // Start generation
    async function startGeneration() {
        const formData = collectFormData();
        const isSourceCompilation = formData.compileFromSource;

        // Validation
        if (!formData.serverHost) {
            alert('Server address is required');
            return;
        }
        if (!formData.serverKey) {
            alert('Server public key is required');
            return;
        }

        buildInProgress = true;
        buildCancelled = false;

        // Show progress
        document.getElementById('configForm').style.display = 'none';
        document.getElementById('buildProgress').classList.add('active');
        document.getElementById('downloadResult').classList.remove('active');

        const modeText = isSourceCompilation ? 'source compilation' : 'config injection';
        updateProgress(0, 'Initializing...', `Preparing ${modeText}`);

        try {
            // Step 1: Download/Prepare
            setStep(1, 'active');
            if (isSourceCompilation) {
                updateProgress(5, 'Preparing sources...', 'Copying RustDesk source code');
            } else {
                updateProgress(10, 'Downloading RustDesk...', `Fetching version ${formData.version} for ${formData.platform}`);
            }

            const token = localStorage.getItem('authToken');
            
            // For source compilation, we need to handle long-running request differently
            const fetchOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(formData)
            };

            // Start the fetch
            const fetchPromise = fetch('/api/generator/build', fetchOptions);

            if (isSourceCompilation) {
                // For source compilation, show progress updates while waiting
                setStep(1, 'completed');
                setStep(2, 'active');
                updateProgress(15, 'Modifying sources...', 'Applying your customizations');
                
                await sleep(2000);
                if (buildCancelled) return;
                
                setStep(2, 'completed');
                setStep(3, 'active');
                updateProgress(25, 'Compiling...', 'This may take 10-15 minutes');
                
                // Simulate progress while compiling
                let progress = 25;
                const progressInterval = setInterval(() => {
                    if (progress < 85 && !buildCancelled) {
                        progress += 1;
                        updateProgress(progress, 'Compiling...', `Building binary (${Math.round((progress-25)*100/60)}% complete)`);
                    }
                }, 10000); // Update every 10 seconds
                
                const response = await fetchPromise;
                clearInterval(progressInterval);
                
                if (buildCancelled) return;
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Compilation failed');
                }
                
                // Step 4: Complete
                setStep(3, 'completed');
                setStep(4, 'active');
                updateProgress(100, 'Complete!', result.compiledFromSource ? 'Your custom client is compiled!' : 'Your client is ready');
                
                await sleep(500);
                setStep(4, 'completed');
                
                showDownloadResult(result);
                
            } else {
                // Config injection - original flow
                const response = await fetchPromise;
                
                if (buildCancelled) return;
                
                // Step 2: Configure
                setStep(1, 'completed');
                setStep(2, 'active');
                updateProgress(40, 'Configuring client...', 'Embedding server configuration');
                
                await sleep(500);
                if (buildCancelled) return;
                
                // Step 3: Package
                setStep(2, 'completed');
                setStep(3, 'active');
                updateProgress(70, 'Packaging...', 'Creating distributable package');
                
                const result = await response.json();
                
                if (buildCancelled) return;
                
                if (!result.success) {
                    throw new Error(result.error || 'Generation failed');
                }
                
                // Step 4: Complete
                setStep(3, 'completed');
                setStep(4, 'active');
                updateProgress(100, 'Complete!', 'Your client is ready');
                
                await sleep(500);
                setStep(4, 'completed');
                
                showDownloadResult(result);
            }

        } catch (error) {
            console.error('Generation failed:', error);
            alert('Generation failed: ' + error.message);
            cancelGeneration();
        }
    }

    function updateProgress(percent, text, status) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').textContent = text;
        document.getElementById('progressStatus').textContent = status;
    }

    function setStep(num, state) {
        const step = document.getElementById('step' + num);
        step.className = 'progress-step ' + state;
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function cancelGeneration() {
        buildCancelled = true;
        buildInProgress = false;

        document.getElementById('buildProgress').classList.remove('active');
        document.getElementById('configForm').style.display = 'block';

        // Reset steps
        for (let i = 1; i <= 4; i++) {
            setStep(i, '');
        }
    }

    function showDownloadResult(result) {
        document.getElementById('buildProgress').classList.remove('active');
        document.getElementById('downloadResult').classList.add('active');

        document.getElementById('resultFilename').textContent = result.filename || 'Custom-RustDesk';
        document.getElementById('resultPlatform').textContent = selectedPlatform;
        document.getElementById('resultVersion').textContent = document.getElementById('rustdeskVersion').value;
        document.getElementById('resultSize').textContent = result.size || 'N/A';

        document.getElementById('downloadBtn').onclick = async function() {
            const downloadUrl = result.downloadUrl || `/api/generator/download/${result.buildId}`;
            const token = localStorage.getItem('authToken');
            
            try {
                const response = await fetch(downloadUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = result.filename || 'Custom-RustDesk.exe';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Download failed: ' + error.message);
            }
        };
    }

    function generateAnother() {
        document.getElementById('downloadResult').classList.remove('active');
        document.getElementById('configForm').style.display = 'block';
        buildInProgress = false;

        // Reset steps
        for (let i = 1; i <= 4; i++) {
            setStep(i, '');
        }
    }
    </script>
</body>
</html>
